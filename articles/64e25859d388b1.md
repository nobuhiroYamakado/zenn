---
title: "Apple siliconæ­è¼‰Macä¸Šã®Dockerã®ä¸­ã§pytorch+cpuãŒä½¿ã„ãŸããªã£ãŸæ™‚ã«è‡ªåŠ›ã§wheelã‚’buildã™ã‚‹æ–¹æ³•"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["docker", "mac","apple silicon","pytorch","aarch64"]
published: false
---

## tl;dr
1. https://github.com/pytorch/pytorch ã‚’cloneã™ã‚‹
2. `.devcontainer/Dockerfile`ã®ä¸€è¡Œç›®`FROM mcr.microsoft.com/vscode/devcontainers/miniconda:0-3`ã‚’è‡ªåˆ†ãŒæ¬²ã—ã„python versionã®ã‚‚ã®ã«å¤‰æ›´ã™ã‚‹ã€‚( https://github.com/devcontainers/images/tree/main/src/miniconda ã® historyãªã©ã‚’å‚ç…§ã™ã‚‹)
   - pythorchã®ç‰¹å®šã®versionã‚’ä½¿ã„ãŸã„å ´åˆã¯git tagãŒåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§æˆ»ã™ã“ã¨ãŒã§ãã‚‹ãŒã€å¤ã„commitã«ã¯.devcontainerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆãŒã‚ã‚‹ã®ã§ã€é©å®œãƒˆãƒ©ãƒƒã‚¯å¤–ã«ã—ã¦ãŠã
3. vscodeã®devcontainerç’°å¢ƒã‹ã‚‰`.devcontainer/cpu/devcontainer.json`ã‚’å‚ç…§ã™ã‚‹å½¢ã§devcontainerã‚’èµ·å‹•ã™ã‚‹
![Alt text](/images/image_64e25859d388b1_001.png)
4. devcontainerç’°å¢ƒã§`USE_CUDA=0 USE_CUDNN=0 python setup.py bdist_wheel` ã™ã‚‹
   - ãªãŠç­†è€…ã®ç’°å¢ƒï¼ˆM1 Pro + 32GB RAMï¼‰ã§ã¯Buildã«1æ™‚é–“åŠã»ã©ã‹ã‹ã‹ã‚‹
5. `dist/`é…ä¸‹ã«`torch-1.13.1+git49444c3-cp310-cp310-linux_aarch64.whl`ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹

## ãã‚‚ãã‚‚ä½•ã§ãã‚“ãªã“ã¨ã‚’ã—ãŸã„ã®ã‹
- pytorchã®å…¬å¼whlã¯https://download.pytorch.org/whl/torch/ã«ã‚ã‚‹ãŒã€cpu+linux+aarch64ã®buildã§ã‚‚ã®ã¯ã ã„ãŸã„ã®versionã§æä¾›ã•ã‚Œã¦ã„ãªã„ã€‚
- æ™®æ®µApple siliconæ­è¼‰Macã§é–‹ç™ºã‚’ã—ã¦ã„ã‚‹éš›ã€é–‹ç™ºç’°å¢ƒã‚’devcontainer(docker)ã§æ§‹ç¯‰ã—ã¦ã„ã‚‹ãŸã‚ã€linux_aarch64ç’°å¢ƒã«ãªã‚‹ã€‚
  - Apple siliconä¸Šã§é ‘å¼µã£ã¦x86_64ã«ã™ã‚‹è«¸ã€…ã®æ–¹æ³•ã¯ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒã‚ã‚Šé…ã‹ã£ãŸã‚Šä¸å®‰å®šã ã£ãŸã‚Š(QEMU/Use Rosetta for x86/amd64 emulation on Apple Silicon)ã™ã‚‹ã®ã§ã€å¾®å¦™ãªæ°—æŒã¡ã«ãªã‚‹ã€‚
- æœ¬ç•ªç’°å¢ƒã¯ã‚¯ãƒ©ã‚¦ãƒ‰ãªã®ã§linux+x86_64ã§å‹•ãå‰æã§DockerfileãŒæ›¸ã‹ã‚Œã¦ãŠã‚Šã€imageã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã™ã‚‹ãŸã‚ã«cpuã®ã¿imageã‚’ä½œã‚‹ã“ã¨ãŒå¤šãã€poetryãªã©ã§whlã‚’æŒ‡å®šã—ã¦cpuã®ã¿buildãŒæ¡ç”¨ã•ã‚Œã¦ã„ãŸã‚Šã™ã‚‹ã€‚(ä¸‹å›³)

```toml
[tool.poetry.dependencies]
torch = {version = "1.13.1", source = "pytorch"}
[[tool.poetry.source]]
name = "pytorch"
url = "https://download.pytorch.org/whl/cpu"
priority = "explicit"
```

ã¤ã¾ã‚Šçµæœã¨ã—ã¦ã€Apple silicon Macä¸Šã®dockerç’°å¢ƒã§`poetry install`ãªã©ã¨ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«è©²å½“ã®whlãŒè¦‹ã¤ã‹ã‚‰ãªã„ã¨ã„ã†ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ãŒã§ã‚‹ã€‚

```shell
  â€¢ Installing torch (1.13.1+cpu): Failed

  RuntimeError

  Unable to find installation candidates for torch (1.13.1+cpu)

  at /usr/local/python/3.10.13/lib/python3.10/site-packages/poetry/installation/chooser.py:73 in choose_for
       69â”‚ 
       70â”‚             links.append(link)
       71â”‚ 
       72â”‚         if not links:
    â†’  73â”‚             raise RuntimeError(f"Unable to find installation candidates for {package}")
       74â”‚ 
       75â”‚         # Get the best link
       76â”‚         chosen = max(links, key=lambda link: self._sort_key(package, link))
       77â”‚ 

Cannot install torch.
```

è¦ã™ã‚‹ã«dockerä¸Šã§ãªã‘ã‚Œã°(macosx_arm64ã¯æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§cpuæŒ‡å®šã‚’å¤–ã™å¿…è¦ã¯ã‚ã‚‹ãŒ)æˆåŠŸã™ã‚‹ã—ã€x86_64ã®dockerä¸Šã§ã‚‚æˆåŠŸã™ã‚‹ã®ã§ã€ã€Œlinux_aarch64ã§cpu buildã¨ã‹ãã‚“ãªä¾‹å¤–ç’°å¢ƒçŸ¥ã‚‰ã‚“ãŒãªã€ã¨æ”¾ç½®ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚ã‚‹ã€‚

ç­†è€…ã¯ç’°å¢ƒã‚’æŒã£ã¦ã„ãªã„ãŒã€nativeãªlinux_aarch64ç’°å¢ƒã§ã‚‚åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã¨æ€ã‚ã‚Œã‚‹ã€‚graviton2ãªã©ã®ARMãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒãƒ¼ã‚‚å¢—ãˆã¦ãã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã†ç’°å¢ƒã§ã‚‚åŒæ§˜ã®ç¾è±¡ãŒèµ·ã“ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

ã¨ã„ã†ã“ã¨ã§ã€localã§buildã—ã¦ã€ãã®whlã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚(å…·ä½“çš„ãªæ“ä½œã¯tl;drã‚’å‚ç…§)
ãªãŠpoetryã§é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã‚’æƒãˆãŸã„ã¨ã„ã†æ°—æŒã¡ã¯ã™ã§ã«ç ´ç¶»ã—ã¦ã„ã‚‹ãŒæ°—ã«ã—ãªã„ã“ã¨ã«ã™ã‚‹ã€‚

å…·ä½“çš„ãªwhlãƒ•ã‚¡ã‚¤ãƒ«ã‚’poetryã§æŒ‡å®šã™ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

```toml
[tool.poetry.dependencies]
torch = { path = "/poetry_wheels/torch-1.13.1+git49444c3-cp310-cp310-linux_aarch64.whl"}
```

ã¡ãªã¿ã«linux_aarch64ä¸Šã§ã‚‚ cpu buildæŒ‡å®šã—ãªã‘ã‚Œã°ã„ã„ã˜ã‚ƒã‚“ã¨ã„ã†è©±ãŒã‚ã‚‹ãŒã€ä»Šåº¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«CUDAä¾å­˜ãŒã‚ã‚‹ã®ã§ã€linux_aarch64 on docker on apple silicon macã§ã¯è©°ã¿ã§ã‚ã‚‹ã€‚
```
 â€¢ Installing nvidia-cuda-nvrtc-cu11 (11.7.99): Failed

  RuntimeError

  Unable to find installation candidates for nvidia-cuda-nvrtc-cu11 (11.7.99)

  at /usr/local/python/3.10.13/lib/python3.10/site-packages/poetry/installation/chooser.py:73 in choose_for
       69â”‚ 
       70â”‚             links.append(link)
       71â”‚ 
       72â”‚         if not links:
    â†’  73â”‚             raise RuntimeError(f"Unable to find installation candidates for {package}")
       74â”‚ 
       75â”‚         # Get the best link
       76â”‚         chosen = max(links, key=lambda link: self._sort_key(package, link))
       77â”‚ 

Cannot install nvidia-cuda-nvrtc-cu11.
```